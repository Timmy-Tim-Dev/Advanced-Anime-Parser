<?xml version="1.0" encoding="utf-8"?>
<dleplugin>
	<name>Advanced Kodik Parser</name>
	<description>Модуль для парсинга и граббинга аниме/дорам с сайта Shikimori, базы Kodik, а так же World-Art, парсинг анонсов аниме, обновление новостей при выходе новой серии или лучшего качества, тонкие настройки работы cron.</description>
	<icon>uploads/advanced-anime-parser-icon.png</icon>
	<version>4.2.0</version>
	<dleversion>15.0</dleversion>
	<versioncompare>greater</versioncompare>
	<upgradeurl>https://storage.kodik.biz/files/advanced-anime-parser/last_version.json</upgradeurl>
	<filedelete>0</filedelete>
	<needplugin></needplugin>
	<mnotice>1</mnotice>
	<mysqlinstall><![CDATA[DROP TABLE IF EXISTS `{prefix}_shikimori_posts`;
CREATE TABLE `{prefix}_shikimori_posts` (
  id int(11) NOT NULL AUTO_INCREMENT,
  post_id int(11) not null default 0,
  shiki_id int(11) not null default 0,
  PRIMARY KEY (id)
) ENGINE={engine} AUTO_INCREMENT=1 DEFAULT CHARSET={charset};


DROP TABLE IF EXISTS `{prefix}_anime_list`;
CREATE TABLE `{prefix}_anime_list` (
  `material_id` int(12) NOT NULL,
  `shikimori_id` varchar(100) NOT NULL,
  `mdl_id` varchar(255) NOT NULL,
  `year` int(6) UNSIGNED NOT NULL,
  `type` varchar(100) NOT NULL,
  `news_id` int(12) UNSIGNED NOT NULL DEFAULT '0',
  `tv_status` varchar(20) NOT NULL,
  `error` int(12) UNSIGNED NOT NULL DEFAULT '0',
  `started` tinyint(1) NOT NULL DEFAULT '0',
  `cat_check` tinyint(1) NOT NULL DEFAULT '0',
  `news_update` tinyint(1) NOT NULL DEFAULT '0',
  `skipped` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`material_id`),
  KEY `shikimori_id` (`shikimori_id`),
  KEY `mdl_id` (`mdl_id`),
  KEY `year` (`year`),
  KEY `type` (`type`),
  KEY `news_id` (`news_id`),
  KEY `tv_status` (`tv_status`),
  KEY `error` (`error`)
) ENGINE=InnoDB DEFAULT CHARSET={charset} COMMENT='База модуля';

ALTER TABLE `{prefix}_anime_list`
  MODIFY `material_id` int(12) NOT NULL AUTO_INCREMENT;

ALTER TABLE `{prefix}_post`
  MODIFY `tags` text NOT NULL;

ALTER TABLE `{prefix}_post` ADD `franchise_aap` varchar(700) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL;
ALTER TABLE `{prefix}_users` ADD `watched_series` MEDIUMTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL;
ALTER TABLE `{prefix}_users` ADD `push_subscribe` MEDIUMTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL;

DROP TABLE IF EXISTS `{prefix}_rooms_list`;
CREATE TABLE `{prefix}_rooms_list` (
  `id` int(12) NOT NULL AUTO_INCREMENT,
  `url` varchar(200) NOT NULL,
  `leader` varchar(200) NOT NULL,
  `leader_last_login` int(12) UNSIGNED NOT NULL DEFAULT '0',
  `news_id` int(12) NOT NULL,
  `poster` varchar(255) NOT NULL,
  `title` varchar(255) NOT NULL,
  `iframe` varchar(255) NOT NULL,
  `public` tinyint(1) NOT NULL DEFAULT '0',
  `pause` tinyint(1) NOT NULL DEFAULT '1',
  `time` int(5) NOT NULL DEFAULT '0',
  `speed` FLOAT(5,2) NOT NULL DEFAULT '1',
  `created` int(12) NOT NULL DEFAULT '0',
  `episode_num` int(5) NOT NULL DEFAULT '0',
  `season_num` int(5) NOT NULL DEFAULT '0',
  `translation` int(5) NOT NULL DEFAULT '0',
  `shikimori_id` varchar(100) NOT NULL,
  `mdl_id` varchar(255) NOT NULL,
  `visitors_iframe` varchar(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=0 DEFAULT CHARSET={charset} COMMENT='Комнаты совместного просмотра';

DROP TABLE IF EXISTS `{prefix}_rooms_chat`;
CREATE TABLE `{prefix}_rooms_chat` (
  `id` int(12) NOT NULL AUTO_INCREMENT,
  `room_url` varchar(200) NOT NULL,
  `login` varchar(40) NOT NULL,
  `avatar` varchar(255) NOT NULL,
  `time` int(11) NOT NULL,
  `message` varchar(500) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=0 DEFAULT CHARSET={charset} COMMENT='Чаты комнат совместного просмотра';

DROP TABLE IF EXISTS `{prefix}_rooms_visitors`;
CREATE TABLE `{prefix}_rooms_visitors` (
  `id` int(12) NOT NULL AUTO_INCREMENT,
  `room_url` varchar(200) NOT NULL,
  `login` varchar(40) NOT NULL,
  `avatar` varchar(255) NOT NULL,
  `time` int(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=0 DEFAULT CHARSET={charset} COMMENT='Посетители комнат совместного просмотра';

DROP TABLE IF EXISTS `{prefix}_raspisanie_ongoingov`;
CREATE TABLE `{prefix}_raspisanie_ongoingov` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `day_name` varchar(255) NOT NULL,
  `date` varchar(255) NOT NULL,
  `last_update` varchar(255) NOT NULL,
  `anime_list` text NOT NULL,
  PRIMARY KEY (`id`),
  KEY `day_name` (`day_name`)
) ENGINE={engine} DEFAULT CHARSET={charset};

DROP TABLE IF EXISTS `{prefix}_subscribe_info`;
CREATE TABLE `{prefix}_subscribe_info` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL DEFAULT 0,
  `post_id` int(11) NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE={engine} AUTO_INCREMENT=8 DEFAULT CHARSET={charset};

INSERT INTO `{prefix}_raspisanie_ongoingov` (`day_name`) VALUES ('monday');
INSERT INTO `{prefix}_raspisanie_ongoingov` (`day_name`) VALUES ('tuesday');
INSERT INTO `{prefix}_raspisanie_ongoingov` (`day_name`) VALUES ('wednesday');
INSERT INTO `{prefix}_raspisanie_ongoingov` (`day_name`) VALUES ('thursday');
INSERT INTO `{prefix}_raspisanie_ongoingov` (`day_name`) VALUES ('friday');
INSERT INTO `{prefix}_raspisanie_ongoingov` (`day_name`) VALUES ('saturday');
INSERT INTO `{prefix}_raspisanie_ongoingov` (`day_name`) VALUES ('sunday');

DROP TABLE IF EXISTS `{prefix}_telegram_sender`;
CREATE TABLE `{prefix}_telegram_sender` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `news_id` int(11) NOT NULL DEFAULT '0',
  `settings` varchar(255) NOT NULL,
  `error` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=0 DEFAULT CHARSET={charset};]]></mysqlinstall>
	<mysqlupgrade><![CDATA[]]></mysqlupgrade>
	<mysqlenable><![CDATA[INSERT IGNORE INTO `{prefix}_admin_sections` (`name`, `title`, `descr`, `icon`, `allow_groups`) VALUES ('aap', 'Advanced Kodik Parser', 'Парсер-граббер аниме/дорам с базы Kodik, а так же сайтов Shikimori, World-art', 'uploads/advanced-anime-parser-icon.png', '1');]]></mysqlenable>
	<mysqldisable><![CDATA[DELETE FROM `{prefix}_admin_sections` WHERE `name` = 'aap';]]></mysqldisable>
	<mysqldelete><![CDATA[DELETE FROM `{prefix}_admin_sections` WHERE `name` = 'aap';
ALTER TABLE `{prefix}_users` DROP `watched_series`;
ALTER TABLE `{prefix}_users` DROP `push_subscribe`;
ALTER TABLE `{prefix}_post` DROP `franchise_aap`;
DROP TABLE IF EXISTS `{prefix}_anime_list`;
DROP TABLE IF EXISTS `{prefix}_rooms_list`;
DROP TABLE IF EXISTS `{prefix}_rooms_chat`;
DROP TABLE IF EXISTS `{prefix}_rooms_visitors`;
DROP TABLE IF EXISTS `{prefix}_raspisanie_ongoingov`;
DROP TABLE IF EXISTS `{prefix}_shikimori_posts`;
DROP TABLE IF EXISTS `{prefix}_subscribe_info`;
DROP TABLE IF EXISTS `{prefix}_telegram_sender`;]]></mysqldelete>
	<phpinstall><![CDATA[$filePath = ENGINE_DIR . '/mrdeath/aaparser/data/version.php';
if (!file_exists($filePath)) {
   	if (!is_dir(ENGINE_DIR . '/mrdeath')) mkdir(ENGINE_DIR . '/mrdeath', 0777, true);
 	if (!is_dir(ENGINE_DIR . '/mrdeath/aaparser')) mkdir(ENGINE_DIR . '/mrdeath/aaparser', 0777, true);
	if (!is_dir(ENGINE_DIR . '/mrdeath/aaparser/data')) mkdir(ENGINE_DIR . '/mrdeath/aaparser/data', 0777, true);
  
    $fp = fopen($filePath, "w+");
    if ($fp) {
        @chmod($filePath, 0777);
        fwrite($fp, '4.2.0');
        fclose($fp);
    } else {
        echo "Ошибка: Пожалуйста загрузите модуль через менеджер файлов или FTP. Система установки плагинов не может сделать запись";
    }
}]]></phpinstall>
	<phpupgrade><![CDATA[]]></phpupgrade>
	<phpenable><![CDATA[]]></phpenable>
	<phpdisable><![CDATA[]]></phpdisable>
	<phpdelete><![CDATA[]]></phpdelete>
	<notice><![CDATA[<b>Список дополнительных модулей в комплекте:</b>
[ol=1]
[*]Ajax плейлист с запоминанием серий
[*]Расписание выхода серий (только для аниме сайтов)
[*]Блок обновления сериалов
[*]Push уведомления про обновления на сайте
[*]Комнаты совместного просмотра
[*]Google Indexing
[*]Постинг новостей в Telegram
[*]Актёры и персонажи
[*]Карта сайта для Актёров и персонажей
[*]Рейтинг выбранных озвучек
[/ol]]]></notice>
	<file name="engine/inc/addnews.php">
		<operation action="after">
			<searchcode><![CDATA[name="title" id="title" maxlength="250" >]]></searchcode>
			<replacecode><![CDATA[<button onClick="parser_search(); return false;" class="btn bg-info-800 btn-sm btn-raised legitRipple position-left">Поиск на Kodik</button>]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[echo $categoryfilter;]]></searchcode>
			<replacecode><![CDATA[require_once ENGINE_DIR . '/mrdeath/aaparser/file_edits/addeditnews.php';

$kodik_xf_field = $aaparser_config['main_fields']['xf_player'];
$xf_shikimori_id = $aaparser_config['main_fields']['xf_shikimori_id'];
$xf_mdl_id = $aaparser_config['main_fields']['xf_mdl_id'];]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[<span id="related_news"></span>]]></searchcode>
			<replacecode><![CDATA[<div id="parser_result" style="width: 100%;"></div>

<script type="text/javascript">
$(function(){
	var iframe_xf = '{$kodik_xf_field}';
	$('#xf_'+iframe_xf).after('<br><button type="button" onclick="updateKodikPlayer(\'' + iframe_xf + '\');" class="btn bg-slate-600 btn-sm btn-raised position-left legitRipple">Обновить плеер kodik</button>');
});
function updateKodikPlayer(xf)
{
  if ( $("#xf_{$xf_shikimori_id}").val() ) var shiki_id = $("#xf_{$xf_shikimori_id}").val();
  else var shiki_id = 0;
  if ( $("#xf_{$xf_mdl_id}").val() ) var mdl_id = $("#xf_{$xf_mdl_id}").val();
  else var mdl_id = 0;
  if (shiki_id == 0 && mdl_id == 0) {
    Growl.error({
		title: 'Внимание',
		text: 'Заполните поле с shikimori или mdl ID'
	});
  }
  else
  {
	$.post('/engine/ajax/controller.php?mod=anime_grabber&module=anime_parser&action=parser_kodikplayer', { shiki_id:shiki_id, mdl_id:mdl_id }, function(data){
		$("#xf_"+xf).val(data);
    });
  }
}
</script>]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$id = $db->insert_id();]]></searchcode>
			<replacecode><![CDATA[$xf_temp_fields = xfieldsdataload($filecontents);
if ( isset($aaparser_config['main_fields']['xf_shikimori_id']) ) {
  	if ( isset($xf_temp_fields[$aaparser_config['main_fields']['xf_shikimori_id']]) ) {
      	require_once ENGINE_DIR . '/mrdeath/aaparser/functions/module.php';
      	$shikimori_id = $xf_temp_fields[$aaparser_config['main_fields']['xf_shikimori_id']];
      	$base_check_db = $db->super_query( "SELECT shikimori_id, news_id FROM " . PREFIX . "_anime_list WHERE shikimori_id='{$shikimori_id}'" );
      	if ( $base_check_db['shikimori_id'] == $shikimori_id && $base_check_db['news_id'] != $id )
          	$db->query("UPDATE " . PREFIX . "_anime_list SET news_id='{$id}', started=1 WHERE shikimori_id='{$shikimori_id}'");
      	else {
	        $shikimori = request('https://shikimori.me/api/animes/'.$shikimori_id);
	        if ( $shikimori['aired_on'] ) {
		        $aired = explode('-', $shikimori['aired_on']);
		        $year = $aired[0];
	        }
	        else $year = 0;
	        $kind = $shikimori['kind'];
	        $status = $shikimori['status'];

	        $db->query("INSERT INTO " . PREFIX . "_anime_list (shikimori_id, year, type, news_id, tv_status, started) VALUES( '{$shikimori_id}', '{$year}', '{$kind}', '{$id}', '{$status}', '1' ) " );
        }
    }
}
elseif ( isset($aaparser_config['main_fields']['xf_mdl_id']) ) {
  	if ( isset($xf_temp_fields[$aaparser_config['main_fields']['xf_mdl_id']]) ) {
      	require_once ENGINE_DIR . '/mrdeath/aaparser/functions/module.php';
      	$mdl_id = $xf_temp_fields[$aaparser_config['main_fields']['xf_mdl_id']];
      	$base_check_db = $db->super_query( "SELECT mdl_id, news_id FROM " . PREFIX . "_anime_list WHERE mdl_id='{$mdl_id}'" );
      	if ( $base_check_db['mdl_id'] == $mdl_id && $base_check_db['news_id'] != $id )
          	$db->query("UPDATE " . PREFIX . "_anime_list SET news_id='{$id}', started=1 WHERE mdl_id='{$mdl_id}'");
      	else {

          	if ( isset($aaparser_config['settings']['kodik_api_key']) ) $kodik_apikey = $aaparser_config['settings']['kodik_api_key'];
			else $kodik_apikey = '7dc2e47c2c45d4e97206ba7519939ec3';

	        $kodik = request('https://kodikapi.com/search?token='.$kodik_apikey.'&mdl_id='.$mdl_id.'&with_material_data=true');

	        if ( $kodik['results'][0]['year'] ) $year = $kodik['results'][0]['year'];
	        else $year = 0;

	        $status = $kodik['results'][0]['material_data']['all_status'];

	        $db->query("INSERT INTO " . PREFIX . "_anime_list (mdl_id, year, news_id, tv_status, started) VALUES( '{$mdl_id}', '{$year}', '{$id}', '{$status}', '1' ) " );
        }
    }
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$need_pass = "<div class]]></searchcode>
			<replacecode><![CDATA[if ( $aaparser_config['push_notifications']['google_indexing'] == 1 ) {
  	$gindexing = "<div class=\"checkbox\"><label><input class=\"icheck\" type=\"checkbox\" id=\"gindexing\" name=\"gindexing\" value=\"1\" checked>Уведомить Google о странице через Indexing Api?</label></div>";
}
else $gindexing = "";
if ( $aaparser_config['push_notifications']['enable_tgposting'] == 1 && $aaparser_config['push_notifications']['tg_addnews'] == 1 ) {
  	if ( $aaparser_config['push_notifications']['tg_addnews_cheched'] == 1 ) $tlg_sender = "<div class=\"checkbox\"><label><input class=\"icheck\" type=\"checkbox\" id=\"tlg_sender\" name=\"tlg_sender\" value=\"1\" checked>Отправить пост в Telegram?</label></div>";
  	else $tlg_sender = "<div class=\"checkbox\"><label><input class=\"icheck\" type=\"checkbox\" id=\"tlg_sender\" name=\"tlg_sender\" value=\"1\">Отправить пост в Telegram?</label></div>";
}
else $tlg_sender = "";]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[{$disable_search}]]></searchcode>
			<replacecode><![CDATA[{$gindexing}
{$tlg_sender}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$parse = new ParseFilter();]]></searchcode>
			<replacecode><![CDATA[$gindexing = isset( $_POST['gindexing'] ) ? intval( $_POST['gindexing'] ) : 0;
$tlg_sender = isset( $_POST['tlg_sender'] ) ? intval( $_POST['tlg_sender'] ) : 0;]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[msg( "success"]]></searchcode>
			<replacecode><![CDATA[if ( $aaparser_config['push_notifications']['google_indexing'] == 1 && $gindexing == 1 ) {
	$indexing_action = 'send';
	$indexing_type = 'URL_UPDATED';
	$indexing_url = $full_link;
	include_once (DLEPlugins::Check(ENGINE_DIR . '/mrdeath/aaparser/google_indexing/indexing.php'));
}
if ( $aaparser_config['push_notifications']['enable_tgposting'] == 1 && $aaparser_config['push_notifications']['tg_addnews'] == 1 && $tlg_sender == 1 ) {
  	$tlg_news_id = $id;
  	$tlg_template = 'addnews';
	require_once (DLEPlugins::Check(ENGINE_DIR . '/mrdeath/aaparser/telegram_sender/telegramsend_init.php'));
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/inc/editnews.php">
		<operation action="before">
			<searchcode><![CDATA[<button onclick="find_relates(); return false;"]]></searchcode>
			<replacecode><![CDATA[<button onClick="parser_search(); return false;" class="btn bg-info-800 btn-sm btn-raised legitRipple position-left">Поиск на Kodik</button>]]></replacecode>
			<enabled>1</enabled>
			<dleversion>16.1</dleversion>
			<versioncompare>less</versioncompare>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[echo $categoryfilter;]]></searchcode>
			<replacecode><![CDATA[require_once ENGINE_DIR . '/mrdeath/aaparser/file_edits/addeditnews.php';

$kodik_xf_field = $aaparser_config['main_fields']['xf_player'];
$xf_shikimori_id = $aaparser_config['main_fields']['xf_shikimori_id'];
$xf_mdl_id = $aaparser_config['main_fields']['xf_mdl_id'];]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[<span id="related_news"></span>]]></searchcode>
			<replacecode><![CDATA[<div id="parser_result" style="width: 100%;"></div>

<script type="text/javascript">
$(function(){
	var iframe_xf = '{$kodik_xf_field}';
	$('#xf_'+iframe_xf).after('<br><button type="button" onclick="updateKodikPlayer(\'' + iframe_xf + '\');" class="btn bg-slate-600 btn-sm btn-raised position-left legitRipple">Обновить плеер kodik</button>');
});
function updateKodikPlayer(xf)
{

  if ( $("#xf_{$xf_shikimori_id}").val() ) var shiki_id = $("#xf_{$xf_shikimori_id}").val();
  else var shiki_id = 0;
  if ( $("#xf_{$xf_mdl_id}").val() ) var mdl_id = $("#xf_{$xf_mdl_id}").val();
  else var mdl_id = 0;
  if (shiki_id == 0 && mdl_id == 0) {
    Growl.error({
		title: 'Внимание',
		text: 'Заполните поле с shikimori или mdl ID'
	});
  }
  else
  {
	$.post('/engine/ajax/controller.php?mod=anime_grabber&module=anime_parser&action=parser_kodikplayer', { shiki_id:shiki_id, mdl_id:mdl_id }, function(data){
		$("#xf_"+xf).val(data);
    });
  }
}
</script>  ]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[deletenewsbyid( $item_db[0] );]]></searchcode>
			<replacecode><![CDATA[$nws_id = $item_db[0];
$base_check_db = $db->super_query( "SELECT news_id FROM " . PREFIX . "_anime_list WHERE news_id='{$nws_id}'" );
if ( $base_check_db['news_id'] == $nws_id )
  	$db->query( "DELETE FROM " . PREFIX . "_anime_list WHERE news_id='{$nws_id}'" );]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[<input type="button" onclick="find_relates(); return false;"]]></searchcode>
			<replacecode><![CDATA[<input type="button" onclick="parser_search(); return false;" class="visible-lg-inline-block btn bg-info-800 btn-sm btn-raised" value="Поиск на Kodik">]]></replacecode>
			<enabled>1</enabled>
			<dleversion>17.0</dleversion>
			<versioncompare>greater</versioncompare>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$need_pass = "<div class]]></searchcode>
			<replacecode><![CDATA[if ( $aaparser_config['push_notifications']['google_indexing'] == 1 ) {
  	$gindexing = "<div class=\"checkbox\"><label><input class=\"icheck\" type=\"checkbox\" id=\"gindexing\" name=\"gindexing\" value=\"1\" checked>Уведомить Google о странице через Indexing Api?</label></div>";
}
else $gindexing = "";
if ( $aaparser_config['push_notifications']['enable_tgposting'] == 1 && $aaparser_config['push_notifications']['tg_editnews'] == 1 ) {
  	if ( $aaparser_config['push_notifications']['tg_editnews_checked'] == 1 ) $tlg_sender = "<div class=\"checkbox\"><label><input class=\"icheck\" type=\"checkbox\" id=\"tlg_sender\" name=\"tlg_sender\" value=\"1\" checked>Отправить пост в Telegram?</label></div>";
  	else $tlg_sender = "<div class=\"checkbox\"><label><input class=\"icheck\" type=\"checkbox\" id=\"tlg_sender\" name=\"tlg_sender\" value=\"1\">Отправить пост в Telegram?</label></div>";
}
else $tlg_sender = "";

if ( !isset($aaparser_config) ) include_once ENGINE_DIR . '/mrdeath/aaparser/data/config.php';
if ( $aaparser_config['integration']['ksep'] == 1 ) {
	$generate_button = "<div class=\"form-group\">
		<label class=\"control-label col-sm-2\">Генерация серий и сезонов</label>
		<div class=\"col-sm-10\">
            <input type=\"button\" id=\"generate_ksep_btn\" data-newsid=\"".$row['id']."\" class=\"visible-lg-inline-block btn bg-info-800 btn-sm btn-raised\" value=\"Сгенерировать серии для посерийки\"><i class=\"help-button visible-lg-inline-block text-primary-600 fa fa-question-circle position-right\" data-rel=\"popover\" data-trigger=\"hover\" data-placement=\"auto right\" data-content=\"После ручного добавления новостей через админку обязательно генерируйте серии для посерийки через данную кнопку\" ></i>
            <span id=\"generate_ksep\" style=\"display:none\">
            	<div class=\"update-status\">
	            	<div class=\"update-status__current\" id=\"updated-current-episode\">0%</div>
	                <div class=\"progress progress-success\">
		            	<div class=\"bar\" id=\"updated-bar-episode\" style=\"width: 0%;\"></div>
	                </div>
	             	<div class=\"update-status__msg\" id=\"result-msg-update-episode\">Ожидаем запуска...</div>
                </div>
            </span>
		</div>
	</div>";
}
else $generate_button = "";]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[{$disable_search}]]></searchcode>
			<replacecode><![CDATA[{$gindexing}
{$tlg_sender}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$id = intval( $_GET['id'] );]]></searchcode>
			<replacecode><![CDATA[$gindexing = isset( $_POST['gindexing'] ) ? intval( $_POST['gindexing'] ) : 0;
$tlg_sender = isset( $_POST['tlg_sender'] ) ? intval( $_POST['tlg_sender'] ) : 0;]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[msg( "success", $lang['edit_alleok']]]></searchcode>
			<replacecode><![CDATA[if ( $aaparser_config['push_notifications']['google_indexing'] == 1 && $gindexing == 1 ) {
	$indexing_action = 'send';
	$indexing_type = 'URL_UPDATED';
	$indexing_url = $full_link;
	include_once (DLEPlugins::Check(ENGINE_DIR . '/mrdeath/aaparser/google_indexing/indexing.php'));
}
if ( $aaparser_config['push_notifications']['enable_tgposting'] == 1 && $aaparser_config['push_notifications']['tg_editnews'] == 1 && $tlg_sender == 1 ) {
  	$tlg_news_id = $id;
  	$tlg_template = 'editnews';
	require_once (DLEPlugins::Check(ENGINE_DIR . '/mrdeath/aaparser/telegram_sender/telegramsend_init.php'));
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[deletenewsbyid( $item_db[0] );]]></searchcode>
			<replacecode><![CDATA[if ( $aaparser_config['push_notifications']['google_indexing'] == 1 ) {
	$row = $db->super_query( "SELECT id, date, category, alt_name FROM " . PREFIX . "_post WHERE id='{$item_db[0]}' LIMIT 1" );
	$config['http_home_url'] = dle_strtolower($config['http_home_url']);

	if( $config['allow_alt_url'] ) {
		if( $config['seo_type'] == 1 OR $config['seo_type'] == 2 ) {
			if( $row['category'] and $config['seo_type'] == 2 ) {
				$cats_url = get_url( $row['category'] );
				if($cats_url) {
					$full_link = $config['http_home_url'] . $cats_url . "/" . $row['id'] . "-" . $row['alt_name'] . ".html";
				} else $full_link = $config['http_home_url'] . $row['id'] . "-" . $row['alt_name'] . ".html";
			} else {
				$full_link = $config['http_home_url'] . $row['id'] . "-" . $row['alt_name'] . ".html";
			}
		} else {
			$full_link = $config['http_home_url'] . date( 'Y/m/d/', strtotime( $row['date'] ) ) . $row['alt_name'] . ".html";
		}
	} else {
		$full_link = $config['http_home_url'] . "index.php?newsid=" . $row['id'];
	}

	$indexing_action = 'send';
	$indexing_type = 'URL_DELETED';
	$indexing_url = $full_link;
	include_once (DLEPlugins::Check(ENGINE_DIR . '/mrdeath/gindexing/indexing.php'));
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[<option value="mass_add_cat">{$lang['add_selcat']}</option>]]></searchcode>
			<replacecode><![CDATA[<option value="mass_gindexing">Уведомить Google о странице через Indexing Api</option>]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[<div class="form-group">
							  <label class="control-label col-sm-2">{$lang['edit_edate']}</label>]]></searchcode>
			<replacecode><![CDATA[{$generate_button}]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/inc/aap.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE' ) || !defined('LOGGED_IN')) {
	die('Hacking attempt!');
}

if (!$user_group[$member_id['user_group']]['admin_complaint']) {
	msg('error', $lang['index_denied'], $lang['index_denied']);
}

include ENGINE_DIR . '/mrdeath/aaparser/admin/index.php';

?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/ajax/anime_grabber.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE' ) ) {
	die('Hacking attempt!');
}

if (isset($_GET['module']) == false) include ENGINE_DIR . '/mrdeath/aaparser/ajax/grabber.php';
else {
  	if ($user_group[$member_id['user_group']]['admin_complaint']) {
      	if ($_GET['module'] == "anime_parser") include ENGINE_DIR . '/mrdeath/aaparser/ajax/parser.php';
        if ($_GET['module'] == "aaparser_save") include ENGINE_DIR . '/mrdeath/aaparser/admin/ajax/save_config.php';
        if ($_GET['module'] == "aaparser_clear") include ENGINE_DIR . '/mrdeath/aaparser/ajax/update_queue.php';
      	if ($_GET['module'] == "kodik_mass_update") include ENGINE_DIR . '/mrdeath/aaparser/ajax/mass_update.php';
      	if ($_GET['module'] == "gindexing" && file_exists(ENGINE_DIR.'/mrdeath/aaparser/google_indexing/indexing.php')) {
            include ENGINE_DIR . '/mrdeath/aaparser/google_indexing/ajax/save.php';
        }
  	}
  	if ($_GET['module'] == "kodik_playlist_ajax") include ENGINE_DIR . '/mrdeath/aaparser/ajax/playlist.php';
  	if ($_GET['module'] == "kodik_playlist_ajax_new") include ENGINE_DIR . '/mrdeath/aaparser/ajax/playlist_new.php';
  	if ($_GET['module'] == "telegram_sender") include ENGINE_DIR . '/mrdeath/aaparser/telegram_sender/telegramsend_cron.php';
  	if ($_GET['module'] == "push_subscribe") include ENGINE_DIR . '/mrdeath/aaparser/ajax/push_subscribe.php';
  	if ($_GET['module'] == "kodik_watched") include ENGINE_DIR . '/mrdeath/aaparser/ajax/save_watched.php';
  	if ($_GET['module'] == "persons") include ENGINE_DIR . '/mrdeath/aaparser/ajax/persons.php';
}
?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/classes/uploads/upload.class.php">
		<operation action="replace">
			<searchcode><![CDATA[if (!$this->tmp_name || !is_uploaded_file($this->tmp_name) ) {
			die( json_encode(array('error' => 'File not send to server' ), JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ) );
		}]]></searchcode>
			<replacecode><![CDATA[if ((!$this->tmp_name || !is_uploaded_file($this->tmp_name)) && !$this->module ) {
			die( json_encode(array('error' => 'File not send to server' ), JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ) );
		}]]></replacecode>
			<enabled>1</enabled>
			<dleversion>15.3</dleversion>
			<versioncompare>greater</versioncompare>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ( !$this->name ){
			die( json_encode(array('error' => 'File not send to server' ), JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ) );
        }]]></searchcode>
			<replacecode><![CDATA[if ( !$this->name && !$this->module ){
			die( json_encode(array('error' => 'File not send to server' ), JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ) );
        }]]></replacecode>
			<enabled>1</enabled>
			<dleversion>15.3</dleversion>
			<versioncompare>greater</versioncompare>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$this->size = $_FILES['qqfile']['size'];]]></searchcode>
			<replacecode><![CDATA[$this->module = isset($_REQUEST['module']) ? $_REQUEST['module'] : false;]]></replacecode>
			<enabled>1</enabled>
			<dleversion>15.3</dleversion>
			<versioncompare>greater</versioncompare>
		</operation>
	</file>
	<file name="engine/modules/main.php">
		<operation action="before">
			<searchcode><![CDATA[echo $tpl->result['main'];]]></searchcode>
			<replacecode><![CDATA[include ENGINE_DIR . '/mrdeath/aaparser/file_edits/main.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[if (stripos ( $tpl->copy_template, "{jsfiles}" ) !== false) {]]></searchcode>
			<replacecode><![CDATA[if ( $aaparser_config['push_notifications']['enable'] && $is_logged) {
	$metatags .= <<<HTML
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
<script>
	var OneSignal = window.OneSignal || [];
	OneSignal.push(function() {
		OneSignal.init({
			appId: "{$aaparser_config['push_notifications']['app_id']}",
		});
	});
	OneSignal.push(function() {
		OneSignal.sendTag("userId", "{$member_id['user_id']}");
	});
</script>
HTML;
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$js_array = build_css($css_array, $config)."\n".build_js($js_array, $config);]]></searchcode>
			<replacecode><![CDATA[include ENGINE_DIR . '/mrdeath/aaparser/file_edits/main2.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$tpl->set ( '{content}', $tpl->result['content'] );]]></searchcode>
			<replacecode><![CDATA[include ENGINE_DIR . '/mrdeath/aaparser/file_edits/main3.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[echo $tpl->result['main'];]]></searchcode>
			<replacecode><![CDATA[if ($is_logged) {
	$subs_count = $db->super_query("SELECT count(*) as count FROM ".PREFIX."_subscribe_info where user_id=".$member_id['user_id']);
	$push_subscribe = json_decode($member_id['push_subscribe'], true);
  
	$tpl->result['main'] = str_replace( '{subscribe-notification-count}', $subs_count['count'], $tpl->result['main'] );
	if ($push_subscribe !== null) {
		$subscribe_count = count($push_subscribe);
	} else {
		$subscribe_count = 0;
	}
  	$tpl->result['main'] = str_replace('{subscribe-total}', $subscribe_count, $tpl->result['main']);
	$tpl->result['main'] = str_replace( '[is_logged]', '', $tpl->result['main'] );
	$tpl->result['main'] = str_replace( '[/is_logged]', '', $tpl->result['main'] );
	
	$checkernewsid = $db->super_query("select id FROM ".PREFIX."_post where id=".$newsid);
  	
	if ($checker_newsid && $newsid>0) {
		$is_viewed = $db->super_query("select count(*) as count FROM ".PREFIX."_subscribe_info where user_id={$member_id['user_id']} and post_id=".$newsid);
		if ($is_viewed['count'] > 0) {
			$db->query("DELETE FROM ".PREFIX."_subscribe_info where user_id={$member_id['user_id']} and post_id=".$newsid);
		}
	}
} else {
	$tpl->result['main'] = preg_replace( "'\\[is_logged\\](.*?)\\[/is_logged\\]'is", "", $tpl->result['main'] );
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/show.full.php">
		<operation action="before">
			<searchcode><![CDATA[$tpl->set( '{short-story}', $row['short_story'] );]]></searchcode>
			<replacecode><![CDATA[include ENGINE_DIR . '/mrdeath/aaparser/file_edits/show.full.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/show.short.php">
		<operation action="before">
			<searchcode><![CDATA[$row['title'] = stripslashes( $row['title'] );]]></searchcode>
			<replacecode><![CDATA[if ( $member_id['watched_series'] ) $watched_series = json_decode($member_id['watched_series'], true);
else $watched_series = [];

$watched_episode = $watched_season = 0;
$watched_translator = '';

foreach ( $watched_series as $key => $value ) {
	if ( $value['news_id'] == $row['id'] ) {
      	$watched_episode = $value['episode'];
      	$watched_season = $value['season'];
      	$watched_translator = $value['translation'];
    }
}

if ( $watched_episode && $watched_season && $watched_translator ) {
  	$tpl->set('[watched_series]', "");
  	$tpl->set('[/watched_series]', "");
	$tpl->set('{watched_episode}', $watched_episode);
	$tpl->set('{watched_season}', $watched_season);
	$tpl->set('{watched_translator}', $watched_translator);
}
else {
  	$tpl->set_block("'\\[watched_series\\](.*?)\\[/watched_series\\]'si", '');
	$tpl->set('{watched_episode}', "");
	$tpl->set('{watched_season}', "");
	$tpl->set('{watched_translator}', "");
}

if ( $aaparser_config['push_notifications']['enable'] && $is_logged ) {
	if ( $member_id['push_subscribe'] ) $push_subscribe = json_decode($member_id['push_subscribe'], true);
	else $push_subscribe = [];

	if ( in_array($row['id'], $push_subscribe) ) {
  		$user_subscribed = '<div class="poster_subscribes"><div class="poster_subscribes-item" title="Вы подписаны"><span class="'.$aaparser_config['push_notifications']['fa_icons'].' fa-bell"></span></div></div>';
	}
	else {
  		$user_subscribed = '';
	}

	$tpl->set( '{user_subscribed}', $user_subscribed );
}
else {
  	$tpl->set( '{user_subscribed}', "" );
}

if ( $dle_module == 'rooms_list' ) {
  	$tpl->set( '{room-url}', $config['http_home_url']."room/".$row['url']."/" );
  	$tpl->set( '{leader-login}', $row['leader'] );
  	$tpl->set( '{leader-link}', $config['http_home_url']."user/".$row['leader']."/" );
  	$tpl->set( '{leader-avatar}', $row['leader_avatar'] );
  	if ( $row['episode_num'] > 0 ) {
      	$tpl->set('[room-episode]', "");
  		$tpl->set('[/room-episode]', "");
      	$tpl->set( '{room-episode}', $row['episode_num'] );
    }
  	else {
      	$tpl->set_block("'\\[room-episode\\](.*?)\\[/room-episode\\]'si", '');
		$tpl->set('{room-episode}', "");
    }
  	if ( $row['season_num'] > 0 ) {
      	$tpl->set('[room-season]', "");
  		$tpl->set('[/room-season]', "");
      	$tpl->set( '{room-season}', $row['season_num'] );
    }
  	else {
      	$tpl->set_block("'\\[room-season\\](.*?)\\[/room-season\\]'si", '');
		$tpl->set('{room-season}', "");
    }
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[if( $category_id and $cat_info[$category_id]['short_tpl'] != '' )]]></searchcode>
			<replacecode><![CDATA[if ( $dle_module == 'subscribe_page' ) $tpl->load_template( 'shortstory_subscribes.tpl' );
elseif ( $dle_module == 'rooms_list' ) $tpl->load_template( 'rooms_shortstory.tpl' );
elseif ( $dle_module == 'continue_watch' ) $tpl->load_template( 'continue_watch.tpl' );
else]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[while ( $row = $db->get_row( $sql_result ) ) {]]></searchcode>
			<replacecode><![CDATA[		if ($do == "subscribe_page" && $is_logged) {
			$is_viewed = $db->super_query("select count(*) as count FROM ".PREFIX."_subscribe_info where user_id={$member_id['user_id']} and post_id=".$row['id']);
			
			if ($is_viewed['count'] > 0) {
				$tpl->set("[subscribe_notviewed]", "");
				$tpl->set("[/subscribe_notviewed]", "");
				$tpl->set_block ( "'\\[subscribe_viewed\\](.*?)\\[/subscribe_viewed\\]'si", "" );
			} else {
				$tpl->set("[subscribe_viewed]", "");
				$tpl->set("[/subscribe_viewed]", "");
				$tpl->set_block ( "'\\[subscribe_notviewed\\](.*?)\\[/subscribe_notviewed\\]'si", "" );

			}			
		} else {
			$tpl->set_block ( "'\\[subscribe_viewed\\](.*?)\\[/subscribe_viewed\\]'si", "" );
			$tpl->set_block ( "'\\[subscribe_notviewed\\](.*?)\\[/subscribe_notviewed\\]'si", "" );
		}
		]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/functions.php">
		<operation action="before">
			<searchcode><![CDATA[if( preg_match( "#xfields=[\"](.+?)[\"]#i", $param_str, $match ) ) {]]></searchcode>
			<replacecode><![CDATA[if( preg_match( "#idshiki=['\"](.+?)['\"]#i", $param_str, $match ) ) {
  		if ( !$aaparser_config ) require_once ENGINE_DIR.'/mrdeath/aaparser/data/config.php';
		$match[1] = explode (',', $match[1]);
		$temp_array = array();
		foreach ($match[1] as $value) {
			$value = $db->safesql(trim($value));
			$temp_array[] = "p.franchise_aap = '{$value}'";
		}
		$where[] = "(".implode(' OR ', $temp_array).")";
	}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[$news_date, $banners]]></searchcode>
			<replacecode><![CDATA[$news_date, $banners, $aaparser_config]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[function totranslit]]></searchcode>
			<replacecode><![CDATA[if ( file_exists(ENGINE_DIR . '/mrdeath/aaparser/data/config.php') ) require_once ENGINE_DIR.'/mrdeath/aaparser/data/config.php';
else $aaparser_config = [];
function DLE_Send_Onesignal ( $params ) {
  	global $aaparser_config;
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'https://onesignal.com/api/v1/notifications');
    curl_setopt(
        $ch,
        CURLOPT_HTTPHEADER,
        [
            'Content-Type: application/json',
            'Authorization: Basic '.$aaparser_config['push_notifications']['rest_api']
        ]
    );
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
    curl_setopt($ch, CURLOPT_HEADER, FALSE);
    curl_setopt($ch, CURLOPT_POST, TRUE);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);

    $response = curl_exec($ch);
    curl_close($ch);

    return $response;
}

function DLE_Send_Push ( $title, $notification, $url = false, $image = false, $user_id = false ) {
  	global $aaparser_config;
  	$params = [
            'app_id' => $aaparser_config['push_notifications']['app_id'],
            'headings' => [
                'en' => $title
            ],
            'contents' => [
                'en' => $notification
            ]
        ];

  	if ( $url ) $params = array_merge($params, [
                'url' => $url
            ]);

  	if ( $image ) $params = array_merge($params, [
                'big_picture' => $image,
      			'chrome_web_image' => $image
            ]);

  	 if( $user_id ) {
     	if ( count($user_id) > 100 ) {
          	$user_mas = array_chunk($user_id, 100);
        }
        else {
        	$user_mas = [];
        	$user_mas[] = $user_id;
        }
       	foreach ( $user_mas as $users_id ) {
        	$filterList = [];
            foreach ($users_id as $key => $value) {
            	if($key > 0) {
                	$filterList[] = [
                    	'operator' => 'OR'
                    ];
                }
                $filterList[] = [
                	'field' => 'tag',
                	'key' => 'userId',
                	'value' => $value,
                	'relation' => '='
                ];
            }
            $params = array_merge($params, [
            	'filters' => $filterList
            ]);
  			$answer = DLE_Send_Onesignal( $params );
        }
     }
     else {
     	$params = array_merge($params, [
     		'included_segments' => [
     			'All'
     		]
     	]);
        $answer = DLE_Send_Onesignal( $params );
     }
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[function custom_print( $matches=array() ) {]]></searchcode>
			<replacecode><![CDATA[include ENGINE_DIR . '/mrdeath/aaparser/file_edits/functions.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[p.id, p.autor, p.date, p.short_story]]></searchcode>
			<replacecode><![CDATA[p.id, p.autor, p.date, p.short_story, p.franchise_aap]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/engine.php">
		<operation action="before">
			<searchcode><![CDATA[case "unsubscribe" :]]></searchcode>
			<replacecode><![CDATA[case "subscribe_page" :
		if ($is_logged) include (DLEPlugins::Check(ENGINE_DIR . '/modules/subscribe_page.php'));
		else {
			@header( "HTTP/1.1 403 Forbidden" );
			msgbox ( $lang['all_err_1'], $lang['fav_error'] );
		}
		break;

case "enter_room" :
		if ($is_logged) include (DLEPlugins::Check(ENGINE_DIR . '/modules/enter_room.php'));
		else {
			@header( "HTTP/1.1 403 Forbidden" );
			msgbox ( $lang['all_err_1'], $lang['fav_error'] );
		}
		break;

case "rooms_list" :
		if ($is_logged) include (DLEPlugins::Check(ENGINE_DIR . '/modules/rooms_list.php'));
		else {
			@header( "HTTP/1.1 403 Forbidden" );
			msgbox ( $lang['all_err_1'], $lang['fav_error'] );
		}
		break;

			
case "characters" :
		include (DLEPlugins::Check(ENGINE_DIR . '/modules/characters.php'));
		break;

case "schedule" :
		include (DLEPlugins::Check(ENGINE_DIR . '/modules/raspisanie_ongoingov.php'));
		break;

case "continue_watch" :
		if ($is_logged) include (DLEPlugins::Check(ENGINE_DIR . '/modules/continue_watch.php'));
		else {
			@header( "HTTP/1.1 403 Forbidden" );
			msgbox ( $lang['all_err_1'], $lang['fav_error'] );
		}
		break;]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/subscribe_page.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

include ENGINE_DIR . '/mrdeath/aaparser/file_edits/subscribe_page.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/ajax/create_room.php">
		<operation action="create">
			<replacecode><![CDATA[<?php
if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

if (!$config['allow_registration'])
{
	$dle_login_hash = sha1( SECURE_AUTH_KEY . $_IP );
}

if($_GET['user_hash'] == "" OR $_GET['user_hash'] != $dle_login_hash)
{
	die('Hacking attempt!');
}

include ENGINE_DIR . '/mrdeath/aaparser/rooms/create_room.php';

?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/enter_room.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

include ENGINE_DIR . '/mrdeath/aaparser/rooms/enter_room.php';

?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/ajax/message_room.php">
		<operation action="create">
			<replacecode><![CDATA[<?php
if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

if (!$config['allow_registration'])
{
	$dle_login_hash = sha1( SECURE_AUTH_KEY . $_IP );
}

if($_GET['user_hash'] == "" OR $_GET['user_hash'] != $dle_login_hash)
{
	die('Hacking attempt!');
}

include ENGINE_DIR . '/mrdeath/aaparser/rooms/message_room.php';

?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/rooms_list.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

include ENGINE_DIR . '/mrdeath/aaparser/rooms/rooms_list.php';

?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/classes/templates.class.php">
		<operation action="before">
			<searchcode><![CDATA[if( stripos( $this->copy_template, "{include file=" ) !== false ) {]]></searchcode>
			<replacecode><![CDATA[if( stripos( $this->copy_template, "{roomscustom" ) !== false ) {
	$this->copy_template = preg_replace_callback( "#\\{roomscustom(.+?)\\}#i", "custom_rooms", $this->copy_template );
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[if (stripos ( $content, "android]" ) !== false) {]]></searchcode>
			<replacecode><![CDATA[if (stripos ( $content, "{kodik_updates_block}" ) !== false) {
if (file_exists(ENGINE_DIR.'/mrdeath/aaparser/data/updates_history.json')) {
    $updates_history = json_decode( file_get_contents( ENGINE_DIR .'/mrdeath/aaparser/data/updates_history.json' ), true );
    if ( is_array($updates_history) && $updates_history ) {
        $kodik_updates_block = '';
        $first_block_styles = 'show';
        $inum = 1;
        $today_date_is = date('Y-m-d', $_TIME);
        $tempdate = strtotime($today_date_is);
        $yesterday_date_is = date('Y-m-d', strtotime("-1 day", $tempdate));
        foreach ( $updates_history as $upd_day => $upd_items ) {
            if ( $first_block_styles ) $first_block_text = 'Свернуть';
            else $first_block_text = 'Развернуть';
            if ( $upd_day == $today_date_is ) $kodik_updates_block .= '<div class="card-header last-update-header di-flex align-items-center">
                    <div class="h6 di-flex mr-auto mb-0">
                        <span>
                            <span class="mr-1">Сегодня</span>
                            <span class="d-none d-xl-inline">('.date('d.m.Y', strtotime($upd_day)).')</span>
                        </span>
                    </div>
                    <a class="bb-dashed-1" onclick="kodik_block_collapse(\''.$inum.'\', this);">'.$first_block_text.'</a>
                    </div>
                    <div id="kodik_block_day_'.$inum.'" style="max-height: 649px;" class="last-update-container scroll collapse '.$first_block_styles.'">';
            elseif ( $upd_day == $yesterday_date_is ) $kodik_updates_block .= '<div class="card-header last-update-header di-flex align-items-center">
                    <div class="h6 di-flex mr-auto mb-0">
                        <span>
                            <span class="mr-1">Вчера</span>
                            <span class="d-none d-xl-inline">('.date('d.m.Y', strtotime($upd_day)).')</span>
                        </span>
                    </div>
                    <a class="bb-dashed-1" onclick="kodik_block_collapse(\''.$inum.'\', this);">'.$first_block_text.'</a>
                    </div>
                    <div id="kodik_block_day_'.$inum.'" style="max-height: 649px;" class="last-update-container scroll collapse '.$first_block_styles.'">';
            else $kodik_updates_block .= '<div class="card-header last-update-header di-flex align-items-center">
                    <div class="h6 di-flex mr-auto mb-0">
                        <span>
                            <span class="mr-1">'.date('d.m.Y', strtotime($upd_day)).'</span>
                        </span>
                    </div>
                    <a class="bb-dashed-1" onclick="kodik_block_collapse(\''.$inum.'\', this);">'.$first_block_text.'</a>
                    </div>
                    <div id="kodik_block_day_'.$inum.'" style="max-height: 649px;" class="last-update-container scroll collapse '.$first_block_styles.'">';
            $first_block_styles = '';
            foreach ( $upd_items as $upd_item ) {
                $kodik_updates_block .= '<div class="last-update-item list-group-item list-group-item-action border-left-0 border-right-0 border-bottom-0 border-top-0 cursor-pointer" onclick="location.href=\''.$upd_item['link'].'\'" tabindex="-1">
                  <div class="media w-100 align-items-center">
                     <div class="media-left last-update-img mr-2">
                        <div class="img-square lazy br-50" style="background-image: url('.$upd_item['image'].');"></div>
                     </div>
                     <div class="media-body">
                        <div class="di-flex align-items-center">
                           <div class="di-flex mr-auto"><span class="card-link list-group-item-action bg-transparent"><span class="last-update-title font-weight-600">'.$upd_item['title'].'</span></span></div>
                           <div class="ml-3 text-right">
                              <div class="font-weight-600 text-truncate"><span class="season-info">'.$upd_item['season'].' сезон </span>'.$upd_item['episode'].' серия</div>
                              <div class="text-gray-dark-6">('.$upd_item['translation'].')</div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>';
            }
            $kodik_updates_block .= '</div>';
            $inum++;
        }
      	$content = str_ireplace( '{kodik_updates_block}', $kodik_updates_block, $content );
      	$content = str_ireplace( '[kodik_updates_block]', "", $content );
      	$content = str_ireplace( '[/kodik_updates_block]', "", $content );
    }
    else {
        $content = str_ireplace( '{kodik_updates_block}', "", $content );
      	$content = preg_replace( "#\[kodik_updates_block\](.+?)\[/kodik_updates_block\]#is", "", $content );
    }
}
else {
    $content = str_ireplace( '{kodik_updates_block}', "", $content );
    $content = preg_replace( "#\[kodik_updates_block\](.+?)\[/kodik_updates_block\]#is", "", $content );
}
}]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/show.rooms.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

include ENGINE_DIR . '/mrdeath/aaparser/rooms/rooms_custom.php';

?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/raspisanie_ongoingov.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

include ENGINE_DIR . '/mrdeath/aaparser/file_edits/raspisanie_ongoingov.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/inc/massactions.php">
		<operation action="before">
			<searchcode><![CDATA[elseif( $action == "do_mass_edit_cloud" ) {]]></searchcode>
			<replacecode><![CDATA[elseif( $action == "mass_gindexing" ) {
  	if ( $aaparser_config['push_notifications']['google_indexing'] == 1 ) {
		$indexing_url = [];
		$news_ids = implode(',', $selected_news);
		$config['http_home_url'] = dle_strtolower($config['http_home_url']);
		$db->query( "SELECT id, date, alt_name, category FROM " . PREFIX . "_post WHERE id IN ({$news_ids})" );
		while($row = $db->get_row()) {
			if( $config['allow_alt_url'] ) {
				if( $config['seo_type'] == 1 OR $config['seo_type'] == 2 ) {
					if( $row['category'] and $config['seo_type'] == 2 ) {
						$cats_url = get_url( $row['category'] );
						if($cats_url) {
							$full_link = $config['http_home_url'] . $cats_url . "/" . $row['id'] . "-" . $row['alt_name'] . ".html";
						} else $full_link = $config['http_home_url'] . $row['id'] . "-" . $row['alt_name'] . ".html";
					} else {
						$full_link = $config['http_home_url'] . $row['id'] . "-" . $row['alt_name'] . ".html";
					}
				} else {
					$full_link = $config['http_home_url'] . date( 'Y/m/d/', strtotime( $row['date'] ) ) . $row['alt_name'] . ".html";
				}
			} else {
				$full_link = $config['http_home_url'] . "index.php?newsid=" . $row['id'];
			}
			$indexing_url[] = $full_link;
		}
		$indexing_type = 'URL_UPDATED';
		include_once (DLEPlugins::Check(ENGINE_DIR . '/mrdeath/aaparser/google_indexing/indexing_multiple.php'));
		msg("success", "Ссылки отправлены", "Выбранные вами ссылки отправлены в Google Indexing", $_SESSION['admin_referrer']);
    }
  		else msg("success", "Google Indexing отключён", "Вы отключили работу Google Indexing в админке модуля Advanced Kodik Parser", $_SESSION['admin_referrer']);
	}]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/continue_watch.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

include ENGINE_DIR . '/mrdeath/aaparser/file_edits/continue_watch.php';]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/characters.php">
		<operation action="create">
			<replacecode><![CDATA[<?php

if( !defined('DATALIFEENGINE') ) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}
  
include ENGINE_DIR . '/mrdeath/aaparser/file_edits/characters.php';
		
?>]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/show.custom.php">
		<operation action="after">
			<searchcode><![CDATA[while ( $row = $db->get_row( $sql_result ) ) {]]></searchcode>
			<replacecode><![CDATA[		if ($do == "subscribe_page" && $is_logged) {
			$is_viewed = $db->super_query("select count(*) as count FROM ".PREFIX."_subscribe_info where user_id={$member_id['user_id']} and post_id=".$row['id']);
			
			if ($is_viewed['count'] > 0) {
				$tpl->set("[subscribe_notviewed]", "");
				$tpl->set("[/subscribe_notviewed]", "");
				$tpl->set_block ( "'\\[subscribe_viewed\\](.*?)\\[/subscribe_viewed\\]'si", "" );
			} else {
				$tpl->set("[subscribe_viewed]", "");
				$tpl->set("[/subscribe_viewed]", "");
				$tpl->set_block ( "'\\[subscribe_notviewed\\](.*?)\\[/subscribe_notviewed\\]'si", "" );

			}			
		} else {
			$tpl->set_block ( "'\\[subscribe_viewed\\](.*?)\\[/subscribe_viewed\\]'si", "" );
			$tpl->set_block ( "'\\[subscribe_notviewed\\](.*?)\\[/subscribe_notviewed\\]'si", "" );
		}
		]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/classes/google.class.php">
		<operation action="before">
			<searchcode><![CDATA[function generate_static() {]]></searchcode>
			<replacecode><![CDATA[function generate_people() {
	$this->priority = $this->stat_priority;
	$this->changefreq = $this->stat_changefreq;
	
	$data = file_get_contents(ENGINE_DIR."/mrdeath/aaparser/data/people.dat");
	$data = unserialize($data);	
	if (!is_array($data)) return;

	$this->sitemap->links('people.xml', function($map) {
		
		$data = file_get_contents(ENGINE_DIR."/mrdeath/aaparser/data/people.dat");
		$data = unserialize($data);	
		
		foreach ($data as $item)
		{
			if (trim($item['url']) != "")$map->loc($item['url'])->freq($this->changefreq)->lastMod($item['date'])->priority( $this->priority );
		}			
	});
}	
function generate_characters() {
	$this->priority = $this->stat_priority;
	$this->changefreq = $this->stat_changefreq;
	
	$data = file_get_contents(ENGINE_DIR."/mrdeath/aaparser/data/characters.dat");
	$data = unserialize($data);	
	if (!is_array($data)) return;

	$this->sitemap->links('characters.xml', function($map) {
		
		$data = file_get_contents(ENGINE_DIR."/mrdeath/aaparser/data/characters.dat");
		$data = unserialize($data);	
		
		foreach ($data as $item)
		{
			if (trim($item['url']) != "")$map->loc($item['url'])->freq($this->changefreq)->lastMod($item['date'])->priority( $this->priority );
		}			
	});
}	]]></replacecode>
			<enabled>1</enabled>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$this->generate_static();	]]></searchcode>
			<replacecode><![CDATA[$this->generate_characters();
$this->generate_people();]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/inc/include/functions.inc.php">
		<operation action="before">
			<searchcode><![CDATA[function totranslit]]></searchcode>
			<replacecode><![CDATA[if ( file_exists(ENGINE_DIR . '/mrdeath/aaparser/data/config.php') ) require_once ENGINE_DIR.'/mrdeath/aaparser/data/config.php';
else $aaparser_config = [];]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
</dleplugin>